<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>员工周工作统计工具</title>
</head>
<body>
  <h1>员工周工作统计工具</h1>

  <!-- 文件上传和操作按钮 -->
  <input type="file" id="file-input" accept=".xlsx" />
  <button id="process-btn">处理并生成报告</button>
  <a id="download-link" style="display:none; margin-left:10px;">下载结果</a>

  <!-- 引入 SheetJS 和 FileSaver.js -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script>
    document.getElementById("process-btn").addEventListener("click", async () => {
      const fileInput = document.getElementById("file-input");
      const file = fileInput.files[0];
      if (!file) {
        alert("请先选择 Excel 文件");
        return;
      }
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets["Copy of Pivot"];
        if (!sheet) {
          alert("未找到名为 'Copy of Pivot' 的工作表");
          return;
        }
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        if (json.length === 0) {
          alert("工作表为空");
          return;
        }
        const headers = json[0];
        const posIdx = headers.indexOf("Position ID");
        const grandIdx = headers.indexOf("Grand Total");

        // 收集所有有效日期列及其索引
        const dateInfos = headers.map((h, i) => {
          const d = new Date(h);
          return { h, i, d };
        }).filter(info =>
          info.i !== posIdx &&
          info.i !== grandIdx &&
          !isNaN(info.d)
        );

        // 确保按日期排序
        dateInfos.sort((a, b) => a.d - b.d);

        // 计算日期范围标签
        const pad = n => n.toString().padStart(2, '0');
        const fmt = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        const rangeLabel = `${fmt(dateInfos[0].d)} - ${fmt(dateInfos[dateInfos.length - 1].d)}`;

        // 按周分组（周一到周六为一周，跳过周日）
        const weeks = [];
        let cur = [];
        dateInfos.forEach(info => {
          const day = info.d.getDay();
          if (day === 0) return;  // 跳过周日
          if (day === 1 && cur.length) {
            weeks.push(cur);
            cur = [info];
          } else {
            cur.push(info);
          }
        });
        if (cur.length) weeks.push(cur);

        // 统计每个员工的工作周数
        const results = [];
        json.slice(1).forEach(row => {
          const emp = row[posIdx];
          if (emp == null || emp === "Grand Total") return;
          let count = 0;
          weeks.forEach(week => {
            // 只要本周任意一天有值（非空），就算有工作
            if (week.some(info => row[info.i] != null && row[info.i] !== "")) {
              count++;
            }
          });
          results.push([emp, count]);
        });

        // 构建并下载结果 Excel，第二列标题为日期范围
        const newWs = XLSX.utils.aoa_to_sheet([
          ['员工ID', rangeLabel],
          ...results
        ]);
        const newWb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWb, newWs, '员工周工作统计');
        const wbout = XLSX.write(newWb, { bookType: 'xlsx', type: 'array' });
        saveAs(
          new Blob([wbout], { type: 'application/octet-stream' }),
          '员工周工作统计结果.xlsx'
        );
      } catch (err) {
        console.error(err);
        alert('处理时发生错误，请检查文件格式');
      }
    });
  </script>
</body>
</html>

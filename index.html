<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>员工周工作统计工具</title>
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
<body>
  <h1>员工周工作统计工具</h1>

  <!-- 声明依赖包 -->
  <py-env>
    - pandas
    - openpyxl
  </py-env>

  <!-- 文件上传和操作按钮 -->
  <input type="file" id="file-input" accept=".xlsx" />
  <button id="process-btn">处理并生成报告</button>
  <a id="download-link" style="display:none; margin-left:10px;">下载结果</a>

  <!-- PyScript 逻辑 -->
  <py-script>
from js import document, FileReader, Blob, URL
from pyodide.ffi import to_js
import pandas as pd
from io import BytesIO

# 处理文件并生成下载链接

def process_file(evt):
    input_el = document.getElementById("file-input")
    file = input_el.files.item(0)
    if not file:
        return
    reader = FileReader.new()

    def onload(e):
        data = e.target.result
        df = pd.read_excel(data, sheet_name='Copy of Pivot')
        # 筛选日期列
        date_cols = [col for col in df.columns if col not in ['Position ID', 'Grand Total']]
        dates = []
        for col in date_cols:
            try:
                dates.append(pd.to_datetime(col))
            except:
                pass

        # 按周分组（周一到周六为一周，跳过周日）
        def group_weeks(dates):
            weeks = []
            cur = []
            for d in sorted(dates):
                if d.weekday() == 6:
                    continue
                if d.weekday() == 0 and cur:
                    weeks.append(cur)
                    cur = [d]
                else:
                    cur.append(d)
            if cur:
                weeks.append(cur)
            return weeks

        weeks = group_weeks(dates)

        # 统计每个员工的工作周数
        results = []
        for _, row in df.iterrows():
            emp = row['Position ID']
            if pd.isna(emp) or emp == 'Grand Total':
                continue
            count = 0
            for w in weeks:
                if any(
                    (pd.to_datetime(col).date() == d.date() and row[col] == 1)
                    for d in w for col in date_cols
                ):
                    count += 1
            results.append({'员工ID': emp, '工作周数': count})

        # 将结果写入 Excel 并生成 Blob
        out = pd.DataFrame(results)
        buf = BytesIO()
        with pd.ExcelWriter(buf, engine='openpyxl') as writer:
            out.to_excel(writer, index=False, sheet_name='员工周工作统计')
        data_out = buf.getvalue()
        blob = Blob.new([to_js(data_out)], {
            'type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        })
        url = URL.createObjectURL(blob)
        link = document.getElementById("download-link")
        link.href = url
        link.download = '员工周工作统计结果.xlsx'
        link.style.display = 'inline-block'

    reader.onload = onload
    reader.readAsArrayBuffer(file)

# 绑定按钮事件
btn = document.getElementById("process-btn")
btn.addEventListener("click", process_file)
  </py-script>

</body>
</html>
